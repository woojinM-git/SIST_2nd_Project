<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="reservation">
    <!-- map100에서 호출 -->
    <select id="list" resultType="mybatis.vo.ReservationVO" parameterType="String">
        SELECT * FROM reservation
        WHERE timeTableIdx = #{timeTableIdx}
    </select>

    <select id="getDetails" parameterType="long" resultType="mybatis.vo.ReservationVO">
        SELECT
            r.reservIdx,
            r.userIdx,
            m.name AS title,
            'images/movie_poster_default.jpg' AS posterUrl,
            th.tName AS theaterName,
            s.sName AS screenName,
            tt.startTime AS startTime,
            '확인된 좌석 정보' AS seatInfo,
            15000 AS finalAmount
        FROM
            reservation r
                JOIN
            time_table tt ON r.timeTableIdx = tt.timeTableIdx
                JOIN
            movie m ON tt.mIdx = m.mIdx
                JOIN
            theater th ON r.tIdx = th.tIdx
                JOIN
            screen s ON r.sIdx = s.sIdx
        WHERE
            r.reservIdx = #{reservIdx}
    </select>

    <update id="updateStatusToPaid" parameterType="long">
        UPDATE reservation
        SET status = 1
        WHERE reservIdx = #{reservIdx}
    </update>

<!--    하드코딩된 값 제거, #{tIdx}, #{sIdx}, #{timeTableIdx} 등의 파라미터로 교체, 비회원(nIdx) 추가-->
    <insert id="insertReservation" parameterType="mybatis.vo.ReservationVO"
            useGeneratedKeys="true" keyProperty="reservIdx">
        INSERT INTO reservation (
        userIdx, nIdx, tIdx, sIdx, timeTableIdx, priceIdx, reservDate, status
        ) VALUES (
        #{userIdx}, #{nIdx}, #{tIdx}, #{sIdx}, #{timeTableIdx}, #{priceIdx}, NOW(), 1
        )
    </insert>

    <update id="updateReservationToCancelled" parameterType="long">
        UPDATE reservation
        SET status = 0
        WHERE reservIdx = #{reservIdx}
    </update>

    <select id="getScreeningTime" parameterType="long" resultType="mybatis.vo.TimeTableVO">
        SELECT
        tt.*
        FROM
        time_table tt
        JOIN
        reservation r ON tt.timeTableIdx = r.timeTableIdx
        WHERE
        r.reservIdx = #{reservIdx}
    </select>

    <select id="reservNum" resultType="map">
        SELECT
        MONTH(reservDate) AS month,
        COUNT(*) AS reservNum
        FROM
        reservation
        WHERE
        YEAR(reservDate) = YEAR(CURDATE())
        GROUP BY
        MONTH(reservDate)
        ORDER BY
        month
    </select>
</mapper>