<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="timeTable">

    <resultMap id="nowMovie" type="mybatis.vo.TimeTableVO">
        <id property="mIdx" column="mIdx"/>

        <!-- timeTableVO에 있는 멤버변수들 중 List<Movie> m_list; -->
        <collection property="m_list" ofType="mybatis.vo.MovieVO"
                    select="movie.list" column="mIdx"/>
        <!-- movie.list를 호출하면서 mIdx값을 인자로 보낸다. -->
    </resultMap>

    <select id="nowMovie" resultMap="nowMovie"> <!-- 상영중이거나 상영예정인 영화들만 보여주는 쿼리 -->
        SELECT *
        FROM time_table
        WHERE endTime > NOW()
        AND status = 1
    </select>

    <resultMap id="map100" type="mybatis.vo.TimeTableVO">
        <id property="mIdx" column="mIdx"/>
        <id property="sIdx" column="sIdx"/>
        <id property="tIdx" column="tIdx"/>
        <id property="timeTableIdx" column="timeTableIdx"/>

        <!-- timeTableVO에 있는 멤버변수들 중 List<Movie> m_list; -->
        <collection property="m_list" ofType="mybatis.vo.MovieVO"
                    select="movie.list" column="mIdx"/>
        <collection property="s_list" ofType="mybatis.vo.ScreenVO"
                    select="screen.list" column="sIdx"/>
        <collection property="t_list" ofType="mybatis.vo.TheaterVO"
                    select="theater.list" column="tIdx"/>
        <!-- time에서 받은 조건으로 받은 timeTable의 영화들에 따른 예매정보를 바탕으로 남은 좌석을 알려줘야함 -->
        <collection property="r_list" ofType="mybatis.vo.ReservationVO"
                    select="reservation.list" column="timeTableIdx"/>
        <!-- movie.list를 호출하면서 mIdx값을 인자로 보낸다. -->
    </resultMap>


    <!-- 각 인자들을 갖고 비교한 쿼리문을 가져왔는데 화면에 mIdx를 보여주는게 아닌 이름을 보여줘야함 -->
    <select id="time" resultMap="map100" parameterType="Map"> <!-- 인자를 두개받아야해서 Map으로 받음 -->
        SELECT *
        FROM time_table
        WHERE endTime > ${date}
        AND status = 1
        AND mIdx = #{mIdx}
        AND tIdx = #{tIdx}
    </select>

    <select id="select" resultType="mybatis.vo.TimeTableVO" parameterType="mybatis.vo.TimeTableVO">
        SELECT *
        FROM time_table
        WHERE timeTableIdx = #{timeTableIdx}
    </select>

    <select id="theaterTab" resultMap="map100" parameterType="String">
        SELECT * FROM time_table
        WHERE tIdx = #{tIdx}
    </select>

    <!-- 관리자 페이지에서 상영 시간표 정보를 띄울 때 필요한 정보들을 얻어내는 쿼리 (종민) -->
    <!-- 남은 좌석 수가 DB 상에 직접적으로 존재하지 않으므로 서브쿼리를 이용해 시간표에서 예매가 완료된 갯수를 얻어내
         이것을 총 좌석 수에서 빼는 방식으로 이용해서 남은 좌석 수를 구할 수 있게 된다 -->
    <select id="getTimetableList" resultType="mybatis.vo.TimeTableVO">
        select m.name, t.timeTableIdx, t.startTime, t.endTime, t.date, r.tName, s.sName, s.sCount,
        (SELECT COUNT(*) FROM reservation res WHERE res.timeTableIdx = t.timeTableIdx) AS reservationCount
        from time_table t
        inner join movie m ON m.mIdx = t.mIdx
        inner join theater r ON r.tIdx = t.tIdx
        inner join screen s ON s.sIdx = t.sIdx
    </select>
    <!--<select id="getRemainSeat" resultType="mybatis.vo.ReservationVO">
        select * from reservation r
        inner join time_table t ON r.timeTableIdx = t.timeTableIdx
    </select>-->
    <!--<select id="getRemainSeat" resultType="mybatis.vo.TimeTableVO">
        SELECT
        tt.timeTableIdx,
        tt.startTime,
        COUNT(r.reservIdx) AS reservationCount
        FROM
        time_table tt
        LEFT JOIN
        reservation r ON tt.timeTableIdx = r.timeTableIdx
        GROUP BY
        tt.timeTableIdx, tt.startTime
        ORDER BY
        tt.startTime
    </select>-->

    <select id="getTimetableSearch" resultType="mybatis.vo.TimeTableVO" parameterType="Map">
        <!--SELECT tt.timeTableIdx, t.tName, s.sName, m.name, tt.date, tt.startTime, tt.endTime, s.sCount,
        (SELECT COUNT(*) FROM reservation res WHERE res.timeTableIdx = tt.timeTableIdx) AS reservationCount
        FROM time_table tt INNER JOIN theater t ON tt.tIdx = t.tIdx
        INNER JOIN screen s ON tt.sIdx = s.sIdx
        INNER JOIN movie m ON tt.mIdx = m.mIdx-->
        SELECT * FROM(
        SELECT @RN:=@RN+1 AS rnum, a.* FROM(
        SELECT tt.timeTableIdx, t.tName, s.sName, m.name, tt.date, tt.startTime, tt.endTime, s.sCount,
        (SELECT COUNT(*) FROM reservation res WHERE res.timeTableIdx = tt.timeTableIdx) AS reservationCount
        FROM time_table tt INNER JOIN theater t ON tt.tIdx = t.tIdx
        INNER JOIN screen s ON tt.sIdx = s.sIdx
        INNER JOIN movie m ON tt.mIdx = m.mIdx
        <where>
            <if test="datepicker != null and datepicker != ''">
                AND tt.date = #{datepicker}
            </if>

            <if test="theater_status != null and theater_status != '' and theater_status == 'theater'">
                AND t.tName LIKE CONCAT ('%', #{search_keyword}, '%')
            </if>

            <if test="screen_level != null and screen_level != ''">
                <choose>
                    <when test="screen_level == 1">
                        AND s.sName = "1관"
                    </when>
                    <when test="screen_level == 2">
                        AND s.sName = "2관 (3D)"
                    </when>
                    <when test="screen_level == 3">
                        AND s.sName = "3관 (4D)"
                    </when>
                    <when test="screen_level == 4">
                        AND s.sName = "4관"
                    </when>
                    <when test="screen_level == 5">
                        AND s.sName = "5관"
                    </when>
                </choose>
            </if>
        </where>
        ORDER BY timeTableIdx DESC
        ) a, (SELECT @RN:=0) b
        ) c WHERE c.rnum BETWEEN #{begin} AND #{end}
    </select>

    <insert id="createTimeTable" parameterType="Map">
        INSERT INTO time_table (tIdx, mIdx, sIdx, startTime, endTime, status, date)
        VALUES(#{tIdx}, #{mIdx}, #{sIdx}, #{startTime}, #{endTime}, 1, #{date})
    </insert>

    <update id="endTimeTable">
        UPDATE time_table
        SET status = 0
        WHERE endTime &lt; NOW()
    </update>

</mapper>